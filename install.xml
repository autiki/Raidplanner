<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!-- Raidplanner $Id $ -->
<!--For security purposes, please check: http
://www.phpbb.com/mods/ for the latest version of this MOD. 
Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems 
within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
  <header>
    <license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
    <title lang="en-gb">bbDkp RaidPlanner plugin</title>
    <description lang="en-gb">
    bbDkp Raidplanner Plugin installer
    Dependency : bbDkp must be installed before
</description>
    <author-notes lang="en-gb">
    Based on phpbb Calendar by alightner (E.Ford) and phpRaider (K.Spraggs)
    we hope you get everything working. further developement requests, support questions are welcome at www.bbdkp.com</author-notes>
    <author-group>
      <author>
        <realname>Sajaki</realname>
        <email>sajaki9@gmail.com</email>
        <username>Sajaki</username>
        <homepage>http://www.bbdkp.com</homepage>
        <contributions-group>
      	<contributions status="current" from="2010-09-30" position="Developer"/>
      	</contributions-group>	
      </author>   
    </author-group>
	<mod-version>0.0.1</mod-version>
    <installation>
      <level>easy</level>
      <time>300</time>
	<target-version>3.0.7pl1</target-version>
    </installation>
<history>
<entry>
<date>2009-05-25</date>
<rev-version>0.0.1</rev-version>
<changelog lang="en">
<change>first code</change>
</changelog>
</entry>
</history>
    <meta name="generator" content="Phpbb.ModTeam.Tools (c#)" />
  </header>
  <action-group>
    
    	<sql><![CDATA[/* WARNING: do NOT execute the SQL commands on the phpbb_acl_options table more 
    than once if you're upgrading or trying to repair a previous installation of the calendar mod.
    Executing this command more than once will add duplicate entries to the table 
    breaking your current permissions and causing the calendar to malfunction */
    
    INSERT INTO phpbb_acl_options (auth_option, is_global, is_local, founder_only) VALUES ('a_calendar', 1, 0, 0),
    ('m_calendar_edit_other_users_events', 1, 0, 0),
    ('m_calendar_delete_other_users_events', 1, 0, 0),
    ('u_calendar_view_events', 1, 0, 0),
    ('u_calendar_edit_events', 1, 0, 0),
    ('u_calendar_delete_events', 1, 0, 0),
    ('u_calendar_create_public_events', 1, 0, 0),
    ('u_calendar_create_group_events', 1, 0, 0),
    ('u_calendar_create_private_events', 1, 0, 0),
    ('u_calendar_nonmember_groups', 1, 0, 0),
    ('u_calendar_track_rsvps', 1, 0, 0),
    ('u_calendar_allow_guests', 1, 0, 0),
    ('u_calendar_view_headcount', 1, 0, 0),
    ('u_calendar_view_detailed_rsvps', 1, 0, 0),
    ('u_calendar_create_recurring_events', 1, 0, 0),
    ('m_calendar_edit_other_users_rsvps', 1, 0, 0);
    
    CREATE TABLE IF NOT EXISTS `phpbb_calendar_config` (
      `config_name` varchar(255) NOT NULL,
      `config_value` varchar(255) NOT NULL
    );
    
    INSERT INTO `phpbb_calendar_config` (`config_name`, `config_value`) VALUES 
    ('first_day_of_week', '0'),
    ('index_display_week', '0'),
    ('index_display_next_events', '5'),
    ('hour_mode', '12'),
    ('display_truncated_name', '0'),
    ('prune_frequency', '0'),
    ('last_prune', '0'),
    ('prune_limit', '2592000'),
    ('display_hidden_groups', '0'),
    ('time_format','h:i a'),
    ('date_format','M d, Y'),
    ('date_time_format','M d, Y h:i a'),
    ('disp_events_only_on_start','0'),
    ('populate_frequency','86400'),
    ('last_populate','0'),
    ('populate_limit','2592000');
    
    CREATE TABLE IF NOT EXISTS `phpbb_calendar_event_types` (
      `etype_id` tinyint(3) unsigned NOT NULL auto_increment,
      `etype_index` tinyint(3) unsigned NOT NULL default '0',
      `etype_full_name` varchar(255) character set utf8 collate utf8_unicode_ci NOT NULL default '',
      `etype_display_name` varchar(255) character set utf8 collate utf8_unicode_ci NOT NULL default '',
      `etype_color` varchar(6) character set utf8 collate utf8_bin NOT NULL default '',
      `etype_image` varchar(255) NOT NULL,
      PRIMARY KEY  (`etype_id`)
    );
    INSERT INTO `phpbb_calendar_event_types` (`etype_id`,`etype_index`,`etype_full_name`,`etype_display_name`,`etype_color`,`etype_image`) VALUES 
     (1,1,'Generic Event','','','');
    
    CREATE TABLE IF NOT EXISTS `phpbb_calendar_events` (
      `event_id` mediumint(8) unsigned NOT NULL auto_increment,
      `etype_id` tinyint(4) NOT NULL,
      `sort_timestamp` bigint(20) unsigned NOT NULL,
      `event_start_time` bigint(20) unsigned NOT NULL,
      `event_end_time` bigint(20) unsigned NOT NULL,
      `event_all_day` tinyint(2) NOT NULL default '0',
      `event_day` varchar(10) character set utf8 collate utf8_bin NOT NULL default '',
      `event_subject` varchar(255) character set utf8 collate utf8_unicode_ci NOT NULL default '',
      `event_body` longblob NOT NULL,
      `poster_id` mediumint(8) UNSIGNED DEFAULT '0' NOT NULL,
      `event_access_level` tinyint(1) NOT NULL default '0',
      `group_id` mediumint(8) UNSIGNED DEFAULT '0' NOT NULL,
      `group_id_list` varchar(255) character set utf8 collate utf8_unicode_ci NOT NULL default ',',
      `enable_bbcode` tinyint(1) unsigned NOT NULL default '1',
      `enable_smilies` tinyint(1) unsigned NOT NULL default '1',
      `enable_magic_url` tinyint(1) unsigned NOT NULL default '1',
      `bbcode_bitfield` varchar(255) character set utf8 collate utf8_bin NOT NULL default '',
      `bbcode_uid` varchar(8) character set utf8 collate utf8_bin NOT NULL,
      `track_rsvps` tinyint(1) unsigned NOT NULL default '0',
      `allow_guests` tinyint(1) unsigned NOT NULL default '0',
      `rsvp_yes` mediumint(8) unsigned NOT NULL default '0',
      `rsvp_no` mediumint(8) unsigned NOT NULL default '0',
      `rsvp_maybe` mediumint(8) unsigned NOT NULL default '0',
      `recurr_id` mediumint(8) unsigned NOT NULL default '0',
      PRIMARY KEY  (`event_id`)
    );
    
    CREATE TABLE IF NOT EXISTS `phpbb_calendar_recurring_events` (
      `recurr_id` mediumint(8) unsigned NOT NULL auto_increment,
      `etype_id` tinyint(4) NOT NULL,
      `frequency` tinyint(4) NOT NULL default '1',
      `frequency_type` tinyint(4) NOT NULL default '0',
      `first_occ_time` bigint(20) unsigned NOT NULL,
      `final_occ_time` bigint(20) unsigned NOT NULL,
      `event_all_day` tinyint(2) NOT NULL default '0',
      `event_duration` bigint(20) unsigned NOT NULL,
      `week_index` tinyint(2) NOT NULL default '0',
      `first_day_of_week` TINYINT(1) UNSIGNED NOT NULL DEFAULT 0,
      `last_calc_time` bigint(20) unsigned NOT NULL,
      `next_calc_time` bigint(20) unsigned NOT NULL,
      `event_subject` varchar(255) character set utf8 collate utf8_unicode_ci NOT NULL default '',
      `event_body` longblob NOT NULL,
      `poster_id` mediumint(8) unsigned NOT NULL default '0',
      `poster_timezone` decimal(5,2) NOT NULL default '0.00',
      `poster_dst` tinyint(1) unsigned NOT NULL default '0',
      `event_access_level` tinyint(1) NOT NULL default '0',
      `group_id` mediumint(8) unsigned NOT NULL default '0',
      `group_id_list` varchar(255) character set utf8 collate utf8_unicode_ci NOT NULL default ',',
      `enable_bbcode` tinyint(1) unsigned NOT NULL default '1',
      `enable_smilies` tinyint(1) unsigned NOT NULL default '1',
      `enable_magic_url` tinyint(1) unsigned NOT NULL default '1',
      `bbcode_bitfield` varchar(255) character set utf8 collate utf8_bin NOT NULL default '',
      `bbcode_uid` varchar(8) character set utf8 collate utf8_bin NOT NULL,
      `track_rsvps` tinyint(1) unsigned NOT NULL default '0',
      `allow_guests` tinyint(1) unsigned NOT NULL default '0',
      PRIMARY KEY  (`recurr_id`)
    );
    
    CREATE TABLE IF NOT EXISTS `phpbb_calendar_rsvps` (
      `rsvp_id` mediumint(8) unsigned NOT NULL auto_increment,
      `event_id` mediumint(8) unsigned NOT NULL default '0',
      `poster_id` mediumint(8) unsigned NOT NULL default '0',
      `poster_name` varchar(255) collate utf8_bin NOT NULL default '',
      `poster_colour` varchar(6) collate utf8_bin NOT NULL default '',
      `poster_ip` varchar(40) collate utf8_bin NOT NULL default '',
      `post_time` int(11) unsigned NOT NULL default '0',
      `rsvp_val` tinyint(1) unsigned NOT NULL default '0',
      `rsvp_count` smallint(4) unsigned NOT NULL default '1',
      `rsvp_detail` mediumtext collate utf8_bin NOT NULL,
      `bbcode_bitfield` varchar(255) collate utf8_bin NOT NULL default '',
      `bbcode_uid` varchar(8) collate utf8_bin NOT NULL,
      `bbcode_options` tinyint(1) unsigned NOT NULL default '7',
      PRIMARY KEY (`rsvp_id`),
      KEY `event_id` (`event_id`),
      KEY `poster_id` (`poster_id`),
      KEY `eid_post_time` (`event_id`,`post_time`)
    );
    
    CREATE TABLE IF NOT EXISTS `phpbb_calendar_events_watch` (
      `event_id` mediumint(8) unsigned NOT NULL default '0',
      `user_id` mediumint(8) unsigned NOT NULL default '0',
      `notify_status` tinyint(1) unsigned NOT NULL default '0',
      `track_replies` tinyint(1) unsigned NOT NULL default '0',
      KEY `event_id` (`event_id`),
      KEY `user_id` (`user_id`),
      KEY `notify_stat` (`notify_status`)
    );
    
    CREATE TABLE IF NOT EXISTS `phpbb_calendar_watch` (
      `user_id` mediumint(8) unsigned NOT NULL default '0',
      `notify_status` tinyint(1) unsigned NOT NULL default '0',
      KEY `user_id` (`user_id`),
      KEY `notify_stat` (`notify_status`)
    );
    
    ]]></sql>
    
    		<copy>
	    		<file from="root/umil/*.*" to="umil/*.*" />
	    		<file from="root/install/*.*" to="install/*.*" />  		 
    			<file from="root/adm/mods/phpbb_calendar_version.php" to="adm/mods/phpbb_calendar_version.php" />
    			<file from="root/adm/style/acp_calendar.html" to="adm/style/acp_calendar.html" />
    			<file from="root/adm/style/acp_calendar_event_types.html" to="adm/style/acp_calendar_event_types.html" />
    			<file from="root/includes/acp/info/acp_calendar.php" to="includes/acp/info/acp_calendar.php" />
    			<file from="root/includes/acp/acp_calendar.php" to="includes/acp/acp_calendar.php" />
    			<file from="root/includes/functions_calendar.php" to="includes/functions_calendar.php" />
    			<file from="root/language/en/acp/permissions_calendar.php" to="language/en/acp/permissions_calendar.php" />
    			<file from="root/language/en/email/calendar_new_event.txt" to="language/en/email/calendar_new_event.txt" />
    			<file from="root/language/en/email/calendar_updated_event.txt" to="language/en/email/calendar_updated_event.txt" />
    			<file from="root/language/en/email/calendar_updated_reply.txt" to="language/en/email/calendar_updated_reply.txt" />
    			<file from="root/language/en/mods/calendar.php" to="language/en/mods/calendar.php" />
    			<file from="root/language/en/calendar.php" to="language/en/calendar.php" />
    			<file from="root/language/en/calendarpost.php" to="language/en/calendarpost.php" />
    			<file from="root/calendar.php" to="calendar.php" />
    			<file from="root/calendarpost.php" to="calendarpost.php" />
    
    		</copy>
    		<open src="language/en/acp/common.php">
    			<edit>
    				<comment lang="en"><![CDATA[Define ACP calendar strings]]></comment>
    				<find><![CDATA[=> 'Spiders/Robots',]]></find>
    				<action type="after-add"><![CDATA[    'ACP_CALENDAR'				=> 'Calendar',
        'ACP_CALENDAR_SETTINGS'				=> 'Calendar Settings',
        'ACP_CALENDAR_DELETE_EVENT_TYPE'	=> 'Delete event type',
        'ACP_CALENDAR_ETYPES'				=> 'Manage Calendar Event Types',]]></action>
    			</edit>
    		</open>
    		<open src="language/en/acp/styles.php">
    			<edit>
    				<comment lang="en"><![CDATA[Define recurring event icons for prosilver style]]></comment>
    				<find><![CDATA['IMG_ICON_POST_EDIT'			=> 'Edit post',]]></find>
    				<action type="after-add"><![CDATA[	'IMG_ICON_CALENDAR_EDIT_ALL'	=> 'Edit all posts',
    	'IMG_ICON_CALENDAR_DELETE_ALL'	=> 'Delete all posts',]]></action>
    			</edit>
    			<edit>
    				<comment lang="en"><![CDATA[Define main calendar icons for prosilver style]]></comment>
    				<find><![CDATA['IMG_ICON_USER_WARN'		=> 'Warn user',]]></find>
    				<action type="after-add"><![CDATA[	'IMG_BUTTON_CALENDAR_NEW'	=> 'New Event',
    	'IMG_BUTTON_CALENDAR_DAY'	=> 'View Day',
    	'IMG_BUTTON_CALENDAR_WEEK'	=> 'View Week',
    	'IMG_BUTTON_CALENDAR_MONTH'	=> 'View Month',]]></action>
    			</edit>
    		</open>
    		<open src="language/en/common.php">
    			<edit>
    				<comment lang="en"><![CDATA[Define Calendar string]]></comment>
    				<find><![CDATA[=> 'Bytes',]]></find>
    				<action type="after-add"><![CDATA[	'CALENDAR'				=> 'Calendar',
    ]]></action>
    			</edit>
    			<edit>
    				<comment lang="en"><![CDATA[Define Calendar view online strings]]></comment>
    				<find><![CDATA['VIEWED'					=> 'Viewed',
    ]]></find>
    				<action type="after-add"><![CDATA[	'VIEWING_CALENDAR'			=> 'Viewing calendar',
    	'VIEWING_CALENDAR_DAY'		=> 'Viewing calendar day',
    	'VIEWING_CALENDAR_EVENT'	=> 'Viewing calendar event',
    	'VIEWING_CALENDAR_MONTH'	=> 'Viewing calendar month',
    	'VIEWING_CALENDAR_WEEK'		=> 'Viewing calendar week',
    	'EDITING_CALENDAR_EVENT'	=> 'Editing calendar event',
    	'CREATING_CALENDAR_EVENT'	=> 'Creating calendar event',
    
    ]]></action>
    			</edit>
    		</open>
    		<open src="language/en/ucp.php">
    			<edit>
    				<comment lang="en"><![CDATA[Define Calendar UCP strings]]></comment>
    				<find><![CDATA['DISABLE_CENSORS'			=> 'Enable word censoring',
    ]]></find>
    				<action type="after-add"><![CDATA[	'DISPLAY_EVENTS_DAYCOUNT'	=> 'How many days into the future do you want to display?',
    ]]></action>
    			</edit>
    			<edit>
    				<comment lang="en"><![CDATA[Define Calendar UCP module name strings]]></comment>
    				<find><![CDATA['UCP_MAIN_ATTACHMENTS'		=> 'Manage attachments',]]></find>
    				<action type="after-add"><![CDATA[	'UCP_MAIN_CALENDAR_MYEVENTS'	=> 'Manage my events',
    	'UCP_MAIN_CALENDAR_REGISTRATION'=> 'Manage event registration',
    ]]></action>
    			</edit>
    		</open>
    		<open src="includes/acp/acp_language.php">
    			<edit>
    				<comment lang="en"><![CDATA[Define calendar icons for prosilver style]]></comment>
    				<find>'icon_back_top', 'icon_contact_aim', 'icon_contact_email',</find>
    				<inline-edit>
    					<inline-find><![CDATA['icon_post_edit',]]></inline-find>
    					<inline-action type="after-add"><![CDATA[ 'icon_calendar_edit_all', 'icon_calendar_delete_all',]]></inline-action>
    					<inline-find><![CDATA['button_topic_reply',]]></inline-find>
    					<inline-action type="after-add"><![CDATA[ 'button_calendar_new', 'button_calendar_day', 'button_calendar_week', 'button_calendar_month',]]></inline-action>
    				</inline-edit>
    			</edit>
    		</open>
    		<open src="includes/acp/acp_styles.php">
    			<edit>
    				<comment lang="en"><![CDATA[Define calendar icons for prosilver style]]></comment>
    				<find>'icon_back_top', 'icon_contact_aim', 'icon_contact_email',</find>
    				<inline-edit>
    					<inline-find><![CDATA['icon_post_edit',]]></inline-find>
    					<inline-action type="after-add"><![CDATA[ 'icon_calendar_edit_all', 'icon_calendar_delete_all',]]></inline-action>
    					<inline-find><![CDATA['button_topic_reply',]]></inline-find>
    					<inline-action type="after-add"><![CDATA[ 'button_calendar_new', 'button_calendar_day', 'button_calendar_week', 'button_calendar_month',]]></inline-action>
    				</inline-edit>
    			</edit>
    		</open>
    		<open src="includes/ucp/info/ucp_main.php">
    			<edit>
    				<comment lang="en"><![CDATA[Define Calendar modules]]></comment>
    				<find><![CDATA['subscribed'	=> array('title' => 'UCP_MAIN_SUBSCRIBED', 'auth' => '', 'cat' => array('UCP_MAIN')),
    ]]></find>
    				<action type="after-add"><![CDATA[				'calendar_registration'		=> array('title' => 'UCP_MAIN_CALENDAR_REGISTRATION', 'auth' => '', 'cat' => array('UCP_MAIN')),
    				'calendar_myevents'		=> array('title' => 'UCP_MAIN_CALENDAR_MYEVENTS', 'auth' => '', 'cat' => array('UCP_MAIN')),
    ]]></action>
    			</edit>
    		</open>
    		<open src="includes/ucp/ucp_main.php">
    			<edit>
    				<comment lang="en"><![CDATA[Define Calendar modules actions]]></comment>
    				<find><![CDATA[case 'bookmarks':]]></find>
    				<action type="before-add"><![CDATA[			case 'calendar_registration':
    
    				$user->add_lang('calendar');
    				include_once($phpbb_root_path . 'includes/functions_calendar.' . $phpEx);
    				$daycount = request_var('daycount', 7 );
    				display_users_next_events_for_x_days($daycount, $user->data['user_id'] );
    				$template->assign_vars(array(
    						'U_COUNT_ACTION'	=> $this->u_action,
    						'DAYCOUNT'			=> $daycount ));
    			break;
    
    			case 'calendar_myevents':
    
    				$user->add_lang('calendar');
    				include_once($phpbb_root_path . 'includes/functions_calendar.' . $phpEx);
    				$daycount = request_var('daycount', 7 );
    				display_posters_next_events_for_x_days($daycount, $user->data['user_id'] );
    				$template->assign_vars(array(
    						'U_COUNT_ACTION'	=> $this->u_action,
    						'DAYCOUNT'			=> $daycount ));
    
    			break;
    ]]></action>
    			</edit>
    		</open>
    		<open src="includes/constants.php">
    			<edit>
    				<comment lang="en"><![CDATA[Defines Calendar Table Names]]></comment>
    				<find><![CDATA[define('BOTS_TABLE',				$table_prefix . 'bots');]]></find>
    				<action type="after-add"><![CDATA[define('CALENDAR_CONFIG_TABLE',		$table_prefix . 'calendar_config');
    define('CALENDAR_EVENTS_TABLE',		$table_prefix . 'calendar_events');
    define('CALENDAR_EVENT_TYPES_TABLE',	$table_prefix . 'calendar_event_types');
    define('CALENDAR_RSVP_TABLE',		$table_prefix . 'calendar_rsvps');
    define('CALENDAR_RECURRING_EVENTS_TABLE',	$table_prefix . 'calendar_recurring_events');
    define('CALENDAR_EVENTS_WATCH',		$table_prefix . 'calendar_events_watch');
    define('CALENDAR_WATCH',			$table_prefix . 'calendar_watch');
    ]]></action>
    			</edit>
    		</open>
    		<open src="includes/functions.php">
    			<edit>
    				<comment lang="en"><![CDATA[Define calendar.php URL with session id]]></comment>
    				<find><![CDATA['U_PROFILE'				=> append_sid("{$phpbb_root_path}ucp.$phpEx"),]]></find>
    				<action type="after-add"><![CDATA['U_CALENDAR'				=> append_sid("{$phpbb_root_path}calendar.$phpEx"),]]></action>
    			</edit>
    			<edit>
    				<comment lang="en"><![CDATA[Call calendar cron jobs when needed]]></comment>
    				<find><![CDATA[if ($cron_type)]]></find>
    						<action type="before-add"><![CDATA[		else if( prune_calendar_required() )
    		{
    			$cron_type = 'prune_calendar';
    		}
    		else if( populate_calendar_required() )
    		{
    			$cron_type = 'populate_calendar';
    		}]]></action>
    			</edit>
    			<edit>
    				<comment lang="en"><![CDATA[Not specific to calendar mod, but some users complained that the alt text was being displayed in firefox when the cron job. This hack will prevent the firefox alt text problem.  For more detailed information go to http://www.phpbb.com/community/viewtopic.php?f=70&t=666195&start=1110#p4894745]]></comment>
    				<find><![CDATA[$template->assign_var('RUN_CRON_TASK', '<img src="' . append_sid($phpbb_root_path . 'cron.' . $phpEx, 'cron_type=' . $cron_type) . '" width="1" height="1" alt="cron" />');]]></find>
    				<action type="replace-with"><![CDATA[$template->assign_var('RUN_CRON_TASK', '<img src="' . append_sid($phpbb_root_path . 'cron.' . $phpEx, 'cron_type=' . $cron_type) . '" width="1" height="1"  />');]]></action>
    			</edit>
    			<edit>				
    				<comment lang="en"><![CDATA[Define functions that check when calendar cron jobs are needed]]></comment>
    				<find><![CDATA[/**
    * Closing the cache object and the database]]></find>
    				<action type="before-add"><![CDATA[/**
    * Do we need to prune the calendar yet?
    */
    function prune_calendar_required()
    {
    	global $db, $sql, $config;
    	$prune_calendar_freq = 0;
    	$sql = 'SELECT * FROM ' . CALENDAR_CONFIG_TABLE ."
    			WHERE config_name ='prune_frequency'";
    	$result = $db->sql_query($sql);
    	if($row = $db->sql_fetchrow($result))
    	{
    		$prune_calendar_freq = $row['config_value'];
    	}
    	$db->sql_freeresult($result);
    	if( $prune_calendar_freq > 0 )
    	{
    		$last_calendar_prune = 0;
    		$sql = 'SELECT * FROM ' . CALENDAR_CONFIG_TABLE ."
    				WHERE config_name ='last_prune'";
    		$result = $db->sql_query($sql);
    		if($row = $db->sql_fetchrow($result))
    		{
    			$last_calendar_prune = $row['config_value'];
    		}
    		$db->sql_freeresult($result);
    		if( time() - $prune_calendar_freq > $last_calendar_prune )
    		{
    			return true;
    		}
    	}
    	return false;
    }
    
    /**
    * Do we need to populate the calendar yet?
    */
    function populate_calendar_required()
    {
    	global $db, $sql, $config;
    	$populate_calendar_freq = 0;
    	$sql = 'SELECT * FROM ' . CALENDAR_CONFIG_TABLE ."
    			WHERE config_name ='populate_frequency'";
    	$result = $db->sql_query($sql);
    	if($row = $db->sql_fetchrow($result))
    	{
    		$populate_calendar_freq = $row['config_value'];
    	}
    	$db->sql_freeresult($result);
    	if( $populate_calendar_freq > 0 )
    	{
    		$last_calendar_populate = 0;
    		$sql = 'SELECT * FROM ' . CALENDAR_CONFIG_TABLE ."
    				WHERE config_name ='last_populate'";
    		$result = $db->sql_query($sql);
    		if($row = $db->sql_fetchrow($result))
    		{
    			$last_calendar_populate = $row['config_value'];
    		}
    		$db->sql_freeresult($result);
    		if( time() - $populate_calendar_freq > $last_calendar_populate )
    		{
    			return true;
    		}
    	}
    	return false;
    }
    ]]></action>
    			</edit>
    		</open>
    		<open src="cron.php">
    			<edit>
    				<comment lang="en"><![CDATA[Add auto prune/populate event support]]></comment>
    				<find><![CDATA[}
    
    // Unloading cache and closing db after having done the dirty work.]]></find>
    				<action type="before-add"><![CDATA[	case 'prune_calendar':
    
    		include_once($phpbb_root_path . 'includes/functions_calendar.' . $phpEx);
    		prune_calendar();
    
    	break;
    	case 'populate_calendar':
    
    		include_once($phpbb_root_path . 'includes/functions_calendar.' . $phpEx);
    		populate_calendar(0);
    
    	break;
    ]]></action>
    			</edit>
    		</open>
    		<open src="index.php">
    			<edit>
    				<comment lang="en"><![CDATA[Include functions_calendar so we can later display the current week or next events on the index]]></comment>
    				<find><![CDATA[include($phpbb_root_path . 'includes/functions_display.' . $phpEx);]]></find>
    				<action type="after-add"><![CDATA[include($phpbb_root_path . 'includes/functions_calendar.' . $phpEx);]]></action>
    			</edit>
    			<edit>
    				<comment lang="en"><![CDATA[Displays current week or next events on index]]></comment>
    				<find><![CDATA[// Assign index specific vars]]></find>
    				<action type="before-add"><![CDATA[// Generate calendar week view or next events if required ...
    calendar_display_calendar_on_index();
    ]]></action>
    			</edit>
    		</open>
    		<open src="viewonline.php" lang="en">
    			<edit>
    				<comment lang="en"><![CDATA[Displays detailed info in who is online page]]></comment>
    				<find><![CDATA[case 'report':
    			$location = $user->lang['REPORTING_POST'];
    			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
    		break;
    ]]></find>
    				<action type="after-add"><![CDATA[		case 'calendar':
    		   preg_match('#view=([a-z]+)#', $row['session_page'], $on_page);
    		   $calendar_mode = (!empty($on_page[1])) ? $on_page[1] : 'month'; /* if no view is defined - they are viewing the month */
    
    		   switch ($calendar_mode)
    		   {
    			  case 'month':
    				 $location = $user->lang['VIEWING_CALENDAR_MONTH'];
    			  break;
    			  case 'week':
    				 $location = $user->lang['VIEWING_CALENDAR_WEEK'];
    			  break;
    			  case 'day':
    				 $location = $user->lang['VIEWING_CALENDAR_DAY'];
    			  break;
    			  case 'event':
    				 $location = $user->lang['VIEWING_CALENDAR_EVENT'];
    			  break;
    			  default:
    				 $location = $user->lang['VIEWING_CALENDAR'];
    			  break;
    		   }
    		   $location_url = append_sid("{$phpbb_root_path}".$row['session_page']);
    		break;
    		case 'calendarpost':
    		   preg_match('#view=([a-z]+)#', $row['session_page'], $on_page);
    		   $calendar_mode = (!empty($on_page[1])) ? $on_page[1] : 'post'; /* if no view is defined - they are creating a new event */
    
    		   switch ($calendar_mode)
    		   {
    			  case 'edit':
    				 $location = $user->lang['EDITING_CALENDAR_EVENT'];
    			  break;
    			  case 'post':
    			  default:
    				 $location = $user->lang['CREATING_CALENDAR_EVENT'];
    			  break;
    		   }
    		   $location_url = append_sid("{$phpbb_root_path}".$row['session_page']);
    		break;
    
    ]]></action>
    
    			</edit>
    		</open>			
    				
    
    
    <diy-instructions lang="en">
Run database installer
----------------------
Browse to install/index.php and run and the Raidplanner table installer
    </diy-instructions>
  </action-group>
</mod>
